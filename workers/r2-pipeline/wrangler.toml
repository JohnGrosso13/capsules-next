name = "r2-pipeline"
main = "src/index.ts"
compatibility_date = "2024-09-01"

# Queues
# - Consumers deliver messages to this worker (no bindings needed)
[[queues.consumers]]
queue = "r2-upload-events"

[[queues.consumers]]
queue = "r2-processing-tasks"

# - Producer binding used by this worker to send tasks to the processing queue
[[queues.producers]]
queue = "r2-processing-tasks"
binding = "PROCESSING_QUEUE"

# KV namespace used to hydrate session metadata in the worker (set your real ID)
[[kv_namespaces]]
binding = "UPLOAD_SESSIONS_KV"
id = "d5b1325b700c47228089a3c9465c3cf7"

[[durable_objects.bindings]]
name = "UPLOAD_COORDINATOR"
class_name = "UploadCoordinator"

[[migrations]]
tag = "v1"
new_classes = ["UploadCoordinator"]

# R2 bucket that holds originals and derived assets
[[r2_buckets]]
binding = "R2_BUCKET"
bucket_name = "capsules-next"

[vars]
PUBLIC_MEDIA_BASE_URL = "https://pub-2b1bf33660e3415da40fb0404caaeaae.r2.dev"
# If you add Cloudflare Image Resizing on a custom domain, point this to that domain + /cdn-cgi/image.
# The r2.dev URL will not provide resizing, but setting it keeps URLs consistent.
IMAGE_RESIZE_BASE_URL = "https://pub-2b1bf33660e3415da40fb0404caaeaae.r2.dev/cdn-cgi/image"
RAW_PREVIEW_BASE_URL = "https://capsules-next-john-grossos-projects.vercel.app/api/uploads/raw-preview"

# Supabase project URL (service role key is stored as a secret, not here)
SUPABASE_URL = "https://znuuipmrdecdawupumja.supabase.co"
# Account context for diagnostics
CF_ACCOUNT_ID = "173291b59bbb656d3287ca191b6d2189"
CF_WAF_RULE_ID = ""
